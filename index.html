<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Burza uÄebnic â€“ mobil</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      text-align: center;
      padding: 20px;
    }
    #preview {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #444;
      border-radius: 10px;
      background: #1c1c1c;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #666;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š Burza uÄebnic</h1>
  <button id="scanBtn">ğŸ“· NaÄÃ­st kÃ³d</button>
  <div id="preview">NaÄtÄ›te uÄebnici...</div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwQyDZPcq2SNLq_A7DELfRIkXxITCR4QvHqH_a6eHvd0JV4fFQKbj5P1Dyyq9Qq3kn0IQ/exec";
    let books = []; // sem uloÅ¾Ã­me celou tabulku

    // === 1) StÃ¡hneme tabulku pÅ™i naÄtenÃ­ strÃ¡nky ===
    async function loadBooks() {
      try {
        const res = await fetch(GAS_URL + "?action=getAllBooks");
        books = await res.json();
        console.log("Tabulka naÄtena:", books.length, "poloÅ¾ek");
      } catch (err) {
        console.error("NepodaÅ™ilo se naÄÃ­st tabulku:", err);
      }
    }

    // === 2) Najdeme knihu lokÃ¡lnÄ› podle kÃ³du ===
    function findBookLocal(code) {
      return books.find(b => String(b.code).trim() === String(code).trim()) || null;
    }

    // === 3) OznaÄÃ­me jako prodanou na serveru ===
    async function markAsSold(code) {
      try {
        const res = await fetch(GAS_URL + "?action=markAsSold&code=" + encodeURIComponent(code));
        return await res.json();
      } catch (err) {
        return { success: false, message: "Chyba pÅ™i komunikaci se serverem" };
      }
    }

    // === 4) SpuÅ¡tÄ›nÃ­ skeneru ===
    async function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            await html5QrCode.stop();
            document.getElementById("reader").remove();
            handleCode(decodedText);
          }
        );
      } catch (err) {
        console.error("Chyba kamery:", err);
      }
    }

    // === 5) ZpracovÃ¡nÃ­ naÄtenÃ©ho kÃ³du ===
    async function handleCode(code) {
      const book = findBookLocal(code);
      if (!book) {
        document.getElementById("preview").innerHTML = "âŒ UÄebnice nenalezena: " + code;
        return;
      }

      document.getElementById("preview").innerHTML = `
        <h2>${book.title}</h2>
        <p><b>Majitel:</b> ${book.owner} (${book.class})</p>
        <p><b>Cena:</b> ${book.price} KÄ + ${book.fee} KÄ pÅ™irÃ¡Å¾ka</p>
        <img src="${book.image}" width="120" /><br/>
        <p><b>Stav:</b> ${book.status}</p>
        ${book.status === "prodano" ? 
          "<p style='color:red'>âŒ JiÅ¾ prodanÃ¡</p>" : 
          `<button onclick="sellBook('${book.code}')">âœ… OznaÄit jako prodanou</button>`
        }
      `;
    }

    // === 6) Prodej knihy ===
    async function sellBook(code) {
      const result = await markAsSold(code);
      alert(result.message);

      // aktualizujeme lokÃ¡lnÃ­ stav
      const b = findBookLocal(code);
      if (b && result.success) b.status = "prodano";

      handleCode(code);
    }

    // === PÅ™ipojenÃ­ tlaÄÃ­tka ===
    document.getElementById("scanBtn").addEventListener("click", () => {
      const readerDiv = document.createElement("div");
      readerDiv.id = "reader";
      document.body.appendChild(readerDiv);
      startScanner();
    });

    // === NaÄti data hned pÅ™i spuÅ¡tÄ›nÃ­ ===
    loadBooks();
  </script>
</body>
</html>
