<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Burza uƒçebnic ‚Äì Skener</title>
  <style>
    :root {
      --bg: #121212;
      --fg: #e0e0e0;
      --accent: #4caf50;
      --danger: #f44336;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: "Segoe UI", Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    video {
      width: 100%;
      max-width: 400px;
      border: 2px solid var(--accent);
      border-radius: 12px;
      margin-bottom: 15px;
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      margin: 6px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { opacity: 0.9; }
    .danger { background: var(--danger); }
    #log, #bookInfo, #orderInfo {
      text-align: left;
      margin: 20px auto;
      padding: 15px;
      background: #1e1e1e;
      border-radius: 10px;
      max-width: 500px;
    }
    #qrcode { margin-top: 15px; text-align: center; }
  </style>
</head>
<body>
  <h1>üìö Burza uƒçebnic</h1>

  <video id="video" autoplay></video><br>
  <button onclick="startScanner()">‚ñ∂Ô∏è Naƒç√≠st k√≥d</button>

  <div id="bookInfo" style="display:none"></div>
  <div id="orderInfo" style="display:none"></div>
  <div id="qrcode"></div>
  <div id="log"></div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const SERVER_URL = "https://script.google.com/macros/s/AKfycbz1VEsJ_7us1pAeaeruw_K7UjKZwxAx1RxuPdvclZTjcwB5B08sSt-JTxCqvFtvK5Tw/exec";
    const IBAN = "CZ8208000000004129739023";
    let codeReader;
    let currentCode = null;
    let booksCache = [];
    let currentOrder = [];

    // Log
    function log(msg) {
      document.getElementById('log').innerHTML += msg + "<br>";
    }

    // Naƒçten√≠ v≈°ech knih
    async function loadBooks() {
      try {
        const res = await fetch(SERVER_URL + "?action=getAll");
        booksCache = await res.json();
        log("üìñ Naƒçteno " + booksCache.length + " knih z datab√°ze.");
      } catch (e) {
        log("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ knih: " + e);
      }
    }

    function findLocalBook(code) {
      return booksCache.find(b => b.kod === code);
    }

    // Skener
    async function startScanner() {
      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
      }
      try {
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        if (devices.length === 0) {
          log("‚ùå Kamera nenalezena");
          return;
        }
        await codeReader.decodeFromVideoDevice(devices[0].deviceId, "video", (result, err) => {
          if (result) {
            currentCode = result.text;
            log("üì∑ Naskenov√°no: " + currentCode);
            codeReader.reset();
            showBook(currentCode);
          }
        });
      } catch (e) {
        log("‚ùå Chyba kamery: " + e);
      }
    }

    // Zobrazen√≠ knihy
    function showBook(code) {
      const book = findLocalBook(code);
      const div = document.getElementById('bookInfo');
      div.style.display = 'block';
      document.getElementById('qrcode').innerHTML = "";

      if (!book) {
        div.innerHTML = "<p>‚ùå Kniha s k√≥dem " + code + " nenalezena.</p>";
        return;
      }

      div.innerHTML = `
        <h3>${book.nazev}</h3>
        <p>K√≥d: ${book.kod}</p>
        <p>Cena: ${book.cena} Kƒç</p>
        <p>Majitel: ${book.jmeno} (${book.email})</p>
        <p>Stav: ${book.stav}</p>
        <button onclick="markAsSold('${book.kod}')">üí∞ Oznaƒçit jako prodanou</button>
        <button onclick="addToOrder('${book.kod}')">‚ûï P≈ôidat do objedn√°vky</button>
      `;
    }

    // Jednotliv√Ω prodej
    async function markAsSold(code) {
      try {
        await fetch(SERVER_URL + "?action=sell&code=" + code);
        log("‚úÖ Kniha " + code + " prod√°na.");
        booksCache = booksCache.map(b => b.kod === code ? {...b, stav:"prod√°no"} : b);
        showBook(code);
      } catch (e) {
        log("‚ùå Chyba p≈ôi oznaƒçen√≠: " + e);
      }
    }

    // P≈ôidat do objedn√°vky
    function addToOrder(code) {
      const book = findLocalBook(code);
      if (!book) return;
      if (book.stav === "prod√°no") {
        log("‚ö†Ô∏è Kniha u≈æ je prodan√°.");
        return;
      }
      if (currentOrder.find(b => b.kod === code)) {
        log("‚ö†Ô∏è Tato kniha u≈æ je v objedn√°vce.");
        return;
      }
      currentOrder.push(book);
      log("üõí P≈ôid√°no: " + book.nazev);
      renderOrder();
    }

    // Render objedn√°vky
    function renderOrder() {
      const orderDiv = document.getElementById('orderInfo');
      if (currentOrder.length === 0) {
        orderDiv.style.display = 'none';
        document.getElementById('qrcode').innerHTML = "";
        return;
      }

      orderDiv.style.display = 'block';
      orderDiv.innerHTML = "<h3>üõí Aktu√°ln√≠ objedn√°vka:</h3>";

      let total = 0;
      currentOrder.forEach((book, index) => {
        const price = parseFloat(book.cena) || 0;
        total += price;

        orderDiv.innerHTML += `
          <p>
            ${book.nazev} ‚Äì ${price} Kƒç 
            <button class="danger" onclick="removeFromOrder(${index})">‚ùå</button>
          </p>`;
      });

      orderDiv.innerHTML += `<p><b>Celkem: ${total} Kƒç</b></p>`;

      orderDiv.innerHTML += `
        <button onclick="generateOrderQR()">üí≥ QR k√≥d platby (cel√° objedn√°vka)</button>
        <button onclick="markAllAsSold()">‚úÖ Oznaƒçit v≈°echny jako prodan√©</button>
      `;

      generateOrderQR(); // rovnou aktualizujeme QR
    }

    // Odebrat knihu z objedn√°vky
    function removeFromOrder(index) {
      currentOrder.splice(index, 1);
      renderOrder();
    }

    // QR cel√° objedn√°vka
    function generateOrderQR() {
      if (currentOrder.length === 0) return;
      const total = currentOrder.reduce((sum, b) => sum + (parseFloat(b.cena) || 0), 0);
      const message = "Objedn√°vka: " + currentOrder.map(b => b.nazev).join(", ");
      const qrText = `SPD*1.0*ACC:${IBAN}*AM:${total}*CC:CZK*MSG:${message}`;

      document.getElementById('qrcode').innerHTML = "";
      new QRCode(document.getElementById('qrcode'), {
        text: qrText,
        width: 200,
        height: 200
      });
    }

    // Oznaƒçit v≈°echny jako prodan√©
    async function markAllAsSold() {
      for (const book of currentOrder) {
        await markAsSold(book.kod);
      }
      currentOrder = [];
      renderOrder();
      log("‚úÖ Cel√° objedn√°vka prod√°na.");
    }

    loadBooks();
  </script>
</body>
</html>
