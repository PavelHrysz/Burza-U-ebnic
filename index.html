<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Burza uƒçebnic ‚Äì Skener</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #121212; color: #f5f5f5; margin:0; padding:20px; text-align:center; }
    h1 { font-size: 1.6em; margin-bottom: 15px; color: #ffffff; }
    #reader { width: 95%; max-width: 500px; margin:0 auto 20px auto; border: 3px solid #333; border-radius: 12px; overflow: hidden; }
    #result { margin-top:20px; padding:15px; border-radius:12px; background-color:#1e1e1e; box-shadow:0 4px 12px rgba(0,0,0,0.4); display:none; text-align:left; }
    .book-image { max-width:150px; margin:10px auto; display:block; border-radius:6px; }
    .status { font-weight:bold; margin:8px 0; }
    .status.available { color: #69db7c; }
    .status.sold { color:#ff6b6b; }
    button { padding:12px 18px; margin:10px; font-size:1em; border:none; border-radius:10px; cursor:pointer; background: linear-gradient(135deg,#4dabf7,#1971c2); color:white; font-weight:bold; transition: transform 0.15s, opacity 0.15s; }
    button:active { transform: scale(0.95); opacity:0.9; }
    .mark-btn { background: linear-gradient(135deg,#ff6b6b,#c92a2a); margin-top:12px; }
  </style>
</head>
<body>
<h1>üìö Burza uƒçebnic ‚Äì Skener</h1>

<div id="reader"></div>

<input type="text" id="codeInput" placeholder="Zadejte k√≥d">
<button onclick="manualScan()">Vyhledat</button>
<button onclick="startCamera()">Nov√© skenov√°n√≠</button>

<div id="result"></div>

<!-- P≈ôidat tƒõsnƒõ pod kameru a inputy -->
<div id="log" style="margin-top:15px; font-size:0.9em; color:#aaa; text-align:left;"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwQyDZPcq2SNLq_A7DELfRIkXxITCR4QvHqH_a6eHvd0JV4fFQKbj5P1Dyyq9Qq3kn0IQ/exec";
let html5QrcodeScanner = null;

// logovac√≠ funkce
function log(msg){
  const logDiv = document.getElementById("log");
  const time = new Date().toLocaleTimeString();
  logDiv.innerHTML += `[${time}] ${msg}<br>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

// normalizace speci√°ln√≠ch znak≈Ø
function normalizeCode(code) {
  if(!code) return "";
  const map = { "¬∞":"", "+":"1","ƒõ":"2","≈°":"3","ƒç":"4","≈ô":"5","≈æ":"6","√Ω":"7","√°":"8","√≠":"9","√©":"0" };
  return code.split("").map(ch => map[ch]!==undefined ? map[ch] : (/[0-9]/.test(ch) ? ch : "")).join("");
}

// spust√≠me kameru
function startCamera() {
  document.getElementById("result").style.display = "none";
  document.getElementById("codeInput").value = "";

  if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
    html5QrcodeScanner.clear();
  }).catch(()=>{});

  html5QrcodeScanner = new Html5Qrcode("reader");
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    decodedText => {
      html5QrcodeScanner.stop();
      html5QrcodeScanner.clear();
      searchBook(decodedText);
    }
  );

  // kontrola naƒçten√≠ tabulky
  fetch(`${API_URL}?test=1`).then(res => res.json())
    .then(data => log("‚úÖ Tabulka naƒçtena, polo≈æek: " + (data?.length||0)))
    .catch(err => log("‚ùå Nepoda≈ôilo se naƒç√≠st tabulku: " + err));
}

// vyhled√°n√≠ knihy
async function searchBook(code) {
  const normalized = normalizeCode(code);
  if(!normalized) return;

  const res = await fetch(`${API_URL}?code=${encodeURIComponent(normalized)}`);
  const book = await res.json();

  const resultDiv = document.getElementById("result");
  resultDiv.style.display = "block";

  if(!book) {
    resultDiv.innerHTML = "<p>‚ùå Uƒçebnice nenalezena.</p>";
    log("‚ùå Nenalezeno: " + normalized);
    return;
  }

  const isSold = book.status.toLowerCase() === "prodano";
  const statusClass = isSold ? "sold" : "available";

  resultDiv.innerHTML = `
    <h3>${book.title}</h3>
    ${book.image ? `<img src="${book.image}" class="book-image">` : ""}
    <p><strong>Majitel:</strong> ${book.owner} (${book.class})</p>
    <p><strong>Email:</strong> ${book.email}</p>
    <p><strong>Cena:</strong> ${book.price} Kƒç (+${book.fee} Kƒç p≈ôir√°≈æka)</p>
    <p class="status ${statusClass}">Stav: ${book.status}</p>
    ${!isSold ? `<button class="mark-btn" onclick="markAsSold('${normalized}')">Oznaƒçit jako prodan√©</button>` : ""}
  `;

  log("‚úÖ Uƒçebnice nalezena: " + normalized);
  document.getElementById("codeInput").value = "";
}

// oznaƒçen√≠ jako prodan√©
async function markAsSold(code) {
  const res = await fetch(`${API_URL}?code=${encodeURIComponent(code)}&action=markAsSold`);
  const data = await res.json();
  alert(data.message);
  startCamera();
}

// start kamery p≈ôi naƒçten√≠
startCamera();
</script>

</body>
</html>
