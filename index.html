<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Burza uƒçebnic ‚Äì Skener</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  body { font-family: Arial, sans-serif; background-color: #121212; color: #f5f5f5; margin:0; padding:20px; text-align:center; }
  h1 { font-size:1.6em; margin-bottom:15px; color:#ffffff; }
  #reader { width:95%; max-width:500px; margin:0 auto 20px auto; border:3px solid #333; border-radius:12px; overflow:hidden; }
  input { padding:12px; font-size:1.1em; width:70%; max-width:280px; border:2px solid #333; border-radius:10px; background:#1e1e1e; color:#fff; outline:none; }
  button { padding:12px 18px; margin:10px; font-size:1em; border:none; border-radius:10px; cursor:pointer; background:linear-gradient(135deg,#4dabf7,#1971c2); color:white; font-weight:bold; transition: transform 0.15s, opacity 0.15s; }
  button:active { transform:scale(0.95); opacity:0.9; }
  #result { margin-top:20px; padding:15px; border-radius:12px; background-color:#1e1e1e; box-shadow:0 4px 12px rgba(0,0,0,0.4); display:none; text-align:left; }
  .book-image { max-width:150px; margin:10px auto; display:block; border-radius:6px; }
  .status { font-weight:bold; margin:8px 0; }
  .status.available { color:#69db7c; }
  .status.sold { color:#ff6b6b; }
  .mark-btn { margin-top:12px; background:linear-gradient(135deg,#ff6b6b,#c92a2a); }
</style>
</head>
<body>
<h1>üìö Burza uƒçebnic ‚Äì Skener</h1>

<div id="reader"></div>
<input type="text" id="codeInput" placeholder="Zadejte k√≥d">
<button onclick="manualScan()">Vyhledat</button>
<button onclick="startCamera()">Spustit kameru</button>

<div id="result"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwQyDZPcq2SNLq_A7DELfRIkXxITCR4QvHqH_a6eHvd0JV4fFQKbj5P1Dyyq9Qq3kn0IQ/exec";
let books = [];
let soldCodes = new Set();
let currentBook = null;
let html5QrcodeScanner = null;

// --- naƒçten√≠ v≈°ech knih p≈ôi startu ---
google.script.run.withSuccessHandler(data => {
  books = data;
  console.log("Tabulka naƒçtena, polo≈æek:", books.length);
  startCamera();
}).getAllBooks();

// ========== KAMERA ==========
function startCamera(){
  document.getElementById("result").style.display = "none";
  const readerDiv = document.getElementById("reader");
  readerDiv.style.display = "block";

  if(html5QrcodeScanner){
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, onScanSuccess, onScanError);
    });
    return;
  }

  html5QrcodeScanner = new Html5Qrcode("reader");
  html5QrcodeScanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, onScanSuccess, onScanError);
}

function stopCamera(){
  if(html5QrcodeScanner){
    html5QrcodeScanner.stop().then(()=>{ document.getElementById("reader").style.display="none"; }).catch(()=>{});
  }
}

function onScanSuccess(decodedText){
  stopCamera();
  searchBook(decodedText);
}

function onScanError(errMsg){
  // ignorujeme chyby, kamera jede d√°l
}

// ========== VYHLED√ÅN√ç ==========
function manualScan(){
  const code = document.getElementById("codeInput").value.trim();
  if(!code) return;
  searchBook(code);
}

function normalizeCode(code){
  // p≈ôevod znak≈Ø ¬∞¬∞+ƒõ≈°ƒç≈ô≈æ√Ω√°√≠√© ‚Üí 1234567890
  const map = {"¬∞":"", "+":"1","ƒõ":"2","≈°":"3","ƒç":"4","≈ô":"5","≈æ":"6","√Ω":"7","√°":"8","√≠":"9","√©":"0"};
  let res = "";
  for(let ch of code) res += map[ch]!==undefined ? map[ch] : ch;
  return res;
}

function searchBook(code){
  code = normalizeCode(code);
  document.getElementById("codeInput").value="";

  const book = books.find(b => b.code.toString().trim() === code);
  currentBook = book;

  const resultDiv = document.getElementById("result");
  resultDiv.style.display = "block";

  if(!book){
    resultDiv.innerHTML = "<p>‚ùå Uƒçebnice nenalezena.</p>";
    return;
  }

  const isSold = soldCodes.has(book.code) || book.status.toLowerCase()==="prodano";
  const statusClass = isSold ? "sold" : "available";

  resultDiv.innerHTML = `
    <h3>${book.title}</h3>
    ${book.image ? `<img src="${book.image}" class="book-image">` : ""}
    <p><strong>Majitel:</strong> ${book.owner} (${book.class})</p>
    <p><strong>Email:</strong> ${book.email}</p>
    <p><strong>Cena:</strong> ${book.price} Kƒç (+${book.fee} Kƒç p≈ôir√°≈æka)</p>
    <p class="status ${statusClass}">Stav: ${isSold ? "prodano" : "dostupn√©"}</p>
    ${!isSold ? `<button class="mark-btn" onclick="markAsSold('${book.code}')">Oznaƒçit jako prodan√©</button>` : ""}
  `;
}

// ========== PRODEJ ==========
function markAsSold(code){
  soldCodes.add(code);
  google.script.run.withSuccessHandler(res=>{
    alert(res.message);
    startCamera(); // po oznaƒçen√≠ spust√≠me kameru znovu
  }).markAsSold(code);
}
</script>
</body>
</html>
